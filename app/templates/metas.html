{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Metas da Comunidade</title>
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
    <link rel="stylesheet" href="{% static 'css/metas.css' %}">
</head>

<body class="page-metas">
    <header>
        <div class="menu">
            <img src="{% static 'Assets/logo.png' %}" alt="Logo" class="logo">
            <div class="icons">
                <a href="{% url 'buscar_parceiros' %}">
                    <span class="icon"><svg width="30" height="30" viewBox="0 0 53 57" fill="none"
                            xmlns="http://www.w3.org/2000/svg" alt="lupa">
                            <path
                                d="M43.2833 49.875L29.3708 34.9125C28.2667 35.8625 26.9969 36.6146 25.5615 37.1688C24.126 37.7229 22.5986 38 20.9792 38C16.9674 38 13.572 36.5057 10.7932 33.5172C8.01441 30.5286 6.625 26.8771 6.625 22.5625C6.625 18.2479 8.01441 14.5964 10.7932 11.6078C13.572 8.61927 16.9674 7.125 20.9792 7.125C24.991 7.125 28.3863 8.61927 31.1651 11.6078C33.9439 14.5964 35.3333 18.2479 35.3333 22.5625C35.3333 24.3042 35.0757 25.9469 34.5604 27.4906C34.0451 29.0344 33.3458 30.4 32.4625 31.5875L46.375 46.55L43.2833 49.875ZM20.9792 33.25C23.7396 33.25 26.0859 32.2109 28.0182 30.1328C29.9505 28.0547 30.9167 25.5312 30.9167 22.5625C30.9167 19.5938 29.9505 17.0703 28.0182 14.9922C26.0859 12.9141 23.7396 11.875 20.9792 11.875C18.2188 11.875 15.8724 12.9141 13.9401 14.9922C12.0078 17.0703 11.0417 19.5938 11.0417 22.5625C11.0417 25.5312 12.0078 28.0547 13.9401 30.1328C15.8724 32.2109 18.2188 33.25 20.9792 33.25Z"
                                fill="#1D1B20" />
                        </svg>

                    </span>
                </a>
                <h1
                    style="position: absolute; left: 50%; transform: translateX(-50%); top: 20px; font-size: 1.8em; font-weight: bold;">
                    {{ comunidade.nome }}
                </h1>

                <a href="{% url 'ranking_global' %}">
                    <span class="icon">
                        <svg width="30" height="30" viewBox="0 0 65 65" fill="none" xmlns="http://www.w3.org/2000/svg"
                            alt="rank">
                            <path d="M48.75 54.1666V27.0833M32.5 54.1666V10.8333M16.25 54.1666V37.9166" stroke="#1E1E1E"
                                stroke-width="8" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </span>
                </a>

                <span class="icon"><svg width="30" height="30" viewBox="0 0 65 65" fill="none"
                        xmlns="http://www.w3.org/2000/svg" alt="sino">
                        <path
                            d="M10.8335 51.4584V46.0418H16.2502V27.0834C16.2502 23.3369 17.3786 20.0192 19.6356 17.1303C21.8925 14.1963 24.8266 12.2779 28.4377 11.3751V9.47925C28.4377 8.35078 28.8213 7.40286 29.5887 6.6355C30.4012 5.823 31.3717 5.41675 32.5002 5.41675C33.6286 5.41675 34.5766 5.823 35.3439 6.6355C36.1564 7.40286 36.5627 8.35078 36.5627 9.47925V11.3751C40.1738 12.2779 43.1078 14.1963 45.3647 17.1303C47.6217 20.0192 48.7502 23.3369 48.7502 27.0834V46.0418H54.1668V51.4584H10.8335ZM32.5002 59.5834C31.0106 59.5834 29.7241 59.0643 28.6408 58.0261C27.6026 56.9428 27.0835 55.6563 27.0835 54.1668H37.9168C37.9168 55.6563 37.3752 56.9428 36.2918 58.0261C35.2536 59.0643 33.9897 59.5834 32.5002 59.5834ZM21.6668 46.0418H43.3335V27.0834C43.3335 24.1042 42.2727 21.5539 40.1512 19.4324C38.0297 17.3108 35.4793 16.2501 32.5002 16.2501C29.521 16.2501 26.9707 17.3108 24.8491 19.4324C22.7276 21.5539 21.6668 24.1042 21.6668 27.0834V46.0418Z"
                            fill="#1D1B20" />
                    </svg>
                </span>

                <a href="{% url 'chat' %}">
                    <span class="icon"><svg width="30" height="30" viewBox="0 0 60 60" fill="none"
                            xmlns="http://www.w3.org/2000/svg" alt="chat">
                            <path
                                d="M52.5 28.7501C52.5086 32.0497 51.7377 35.3048 50.25 38.2501C48.4861 41.7794 45.7744 44.748 42.4186 46.8233C39.0629 48.8985 35.1956 49.9985 31.25 50.0001C27.9503 50.0087 24.6953 49.2377 21.75 47.7501L7.5 52.5001L12.25 38.2501C10.7623 35.3048 9.9914 32.0497 10 28.7501C10.0015 24.8045 11.1015 20.9372 13.1768 17.5814C15.2521 14.2257 18.2206 11.514 21.75 9.75007C24.6953 8.2624 27.9503 7.49147 31.25 7.50007H32.5C37.7109 7.78755 42.6326 9.98697 46.3229 13.6772C50.0131 17.3675 52.2125 22.2892 52.5 27.5001V28.7501Z"
                                stroke="#1E1E1E" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </span>
                </a>
                <a href="{% url 'comunidades' %}">
                    <span class="icon"><svg width="30" height="30" viewBox="0 0 45 29" fill="none"
                            xmlns="http://www.w3.org/2000/svg" alt="comunidade">
                            <path
                                d="M10 5.75V0H45V5.75H10ZM10 17.25V11.5H45V17.25H10ZM10 28.75V23H45V28.75H10ZM2.5 5.75C1.79167 5.75 1.19792 5.47448 0.71875 4.92344C0.239583 4.3724 0 3.68958 0 2.875C0 2.06042 0.239583 1.3776 0.71875 0.826562C1.19792 0.275521 1.79167 0 2.5 0C3.20833 0 3.80208 0.275521 4.28125 0.826562C4.76042 1.3776 5 2.06042 5 2.875C5 3.68958 4.76042 4.3724 4.28125 4.92344C3.80208 5.47448 3.20833 5.75 2.5 5.75ZM2.5 17.25C1.79167 17.25 1.19792 16.9745 0.71875 16.4234C0.239583 15.8724 0 15.1896 0 14.375C0 13.5604 0.239583 12.8776 0.71875 12.3266C1.19792 11.7755 1.79167 11.5 2.5 11.5C3.20833 11.5 3.80208 11.7755 4.28125 12.3266C4.76042 12.8776 5 13.5604 5 14.375C5 15.1896 4.76042 15.8724 4.28125 16.4234C3.80208 16.9745 3.20833 17.25 2.5 17.25ZM2.5 28.75C1.79167 28.75 1.19792 28.4745 0.71875 27.9234C0.239583 27.3724 0 26.6896 0 25.875C0 25.0604 0.239583 24.3776 0.71875 23.8266C1.19792 23.2755 1.79167 23 2.5 23C3.20833 23 3.80208 23.2755 4.28125 23.8266C4.76042 24.3776 5 25.0604 5 25.875C5 26.6896 4.76042 27.3724 4.28125 27.9234C3.80208 28.4745 3.20833 28.75 2.5 28.75Z"
                                fill="#1D1B20" />
                        </svg>

                    </span>
                </a>

                {% if user.is_authenticated %}
                <div class="user-menu">
                    <img src="https://img.icons8.com/?size=100&id=23400&format=png&color=000000" alt="usuario"
                        width="35" height="35" class="user-icon" id="user-icon">

                    <div class="dropdown" id="user-dropdown">
                        <a href="{% url 'perfil' %}"><img
                                src="https://img.icons8.com/?size=100&id=82751&format=png&color=000000" alt="usuário"
                                width="25" height="25"> Perfil</a>
                        <a href="#" id="logout-btn"><img
                                src="https://img.icons8.com/?size=100&id=82792&format=png&color=000000" alt="logout"
                                width="25" height="25"> Sair</a>
                    </div>
                </div>

                <!-- Modal de confirmação de logout -->
                <div id="logout-modal" class="modal">
                    <div class="modal-content">
                        <p>Tem certeza que deseja sair?</p>
                        <div class="modal-buttons">
                            <button id="confirm-logout">Sim</button>
                            <button id="cancel-logout">Cancelar</button>
                        </div>
                    </div>
                </div>
                {% else %}
                <a href="{% url 'login' %}" class="login-link">Entrar</a>
                {% endif %}


            </div>
        </div>
    </header>

    <!-- Conteúdo principal -->
    <div class="tema-comunidade" style="--comunidade-bg: {{ cor_bg }}; --comunidade-fg: {{ cor_fg }};">

        <main class="metas-container">

            <!-- Lista de metas -->
            <section class="metas-lista">
                {% if sem_metas %}
                <div class="sem-metas-box">
                    <p>Nenhuma meta foi criada ainda para esta comunidade.</p>
                </div>
                {% else %}
                {% for meta in metas %}
                <div class="meta-card" style="--comunidade-bg: {{ c.cor }}; --comunidade-fg: #fff;">
                    <span class="meta-titulo">{{ meta.titulo }}</span>

                    <form method="POST" action="/meta/{{ meta.id }}/cumprir/" class="checkbox-form">
                        {% csrf_token %}
                        <input type="checkbox" onchange="this.form.submit()">
                    </form>
                </div>

                {% endfor %}



                {% endif %}
            </section>

            <!-- Ranking e ações administrativas -->
            <aside class="ranking-box">
                <div class="ranking-card">
                    <div class="ranking-header">
                        {% if colocacao == 1 %}
                        <!-- SVG ouro -->
                        <svg width="40" height="40" viewBox="0 0 126 131" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M80.2544 42L125.852 112.547L108.201 115.066L97.5972 130.809L51.9999 60.262L80.2544 42Z"
                                fill="#B32C2C" />
                            <path
                                d="M45.5972 41L-0.000175714 111.547L17.651 114.066L28.2543 129.809L73.8517 59.262L45.5972 41Z"
                                fill="#B32C2C" />
                            <path
                                d="M63.5 0.5C86.696 0.5 105.5 19.304 105.5 42.5C105.5 65.696 86.696 84.5 63.5 84.5C40.304 84.5 21.5 65.696 21.5 42.5C21.5 19.304 40.304 0.5 63.5 0.5Z"
                                fill="#DEC130" stroke="#BBB942" />
                        </svg>
                        {% elif colocacao == 2 %}
                        <!-- SVG prata -->
                        <svg width="40" height="40" viewBox="0 0 126 131" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M80.2544 42L125.852 112.547L108.201 115.066L97.5972 130.809L51.9999 60.262L80.2544 42Z"
                                fill="#B32C2C" />
                            <path
                                d="M45.5972 41L-0.000175714 111.547L17.651 114.066L28.2543 129.809L73.8517 59.262L45.5972 41Z"
                                fill="#B32C2C" />
                            <path
                                d="M63.5 0.5C86.696 0.5 105.5 19.304 105.5 42.5C105.5 65.696 86.696 84.5 63.5 84.5C40.304 84.5 21.5 65.696 21.5 42.5C21.5 19.304 40.304 0.5 63.5 0.5Z"
                                fill="#D9D9D9" stroke="#BBBBB6" />
                        </svg>
                        {% elif colocacao == 3 %}
                        <!-- SVG bronze -->
                        <svg width="40" height="40" viewBox="0 0 126 131" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M80.2544 42L125.852 112.547L108.201 115.066L97.5972 130.809L51.9999 60.262L80.2544 42Z"
                                fill="#B32C2C" />
                            <path
                                d="M45.5972 41L-0.000175714 111.547L17.651 114.066L28.2543 129.809L73.8517 59.262L45.5972 41Z"
                                fill="#B32C2C" />
                            <path
                                d="M63.5 0.5C86.696 0.5 105.5 19.304 105.5 42.5C105.5 65.696 86.696 84.5 63.5 84.5C40.304 84.5 21.5 65.696 21.5 42.5C21.5 19.304 40.304 0.5 63.5 0.5Z"
                                fill="#DC9655" stroke="#C48347" />
                        </svg>
                        {% else %}
                        <span class="circle">{{ colocacao|default:"–" }}</span>
                        {% endif %}
                    </div>

                    <p>Sua colocação no ranking é: <strong>{{ colocacao|default:"Sem colocação" }}</strong></p>

                    <div class="ranking-actions">
                        <form method="GET" action="{% url 'ranking' comunidade.id %}">
                            <button class="btn">Ver ranking</button>
                        </form>

                        {% if is_admin %}
                        <button id="btn-abrir-modal" class="btn btn--secondary">Adicionar meta</button>
                        {% endif %}

                        <form method="POST" action="{% url 'sair_comunidade' comunidade.id %}">
                            {% csrf_token %}
                            <button class="btn btn--danger">Sair da comunidade</button>
                        </form>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Modal de adicionar nova meta -->
    <div id="modal-adicionar-meta" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Nova meta</h2>
            <form id="form-meta" method="POST" action="{% url 'criar_meta_ajax' comunidade.id %}">
                {% csrf_token %}
                <label for="titulo">Título da meta:</label>
                <input type="text" name="titulo" id="titulo" required>


                <div class="modal-actions">
                    <button type="submit" class="btn">Criar meta</button>
                    <button type="button" class="btn btn--danger" onclick="fecharModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>




    <script>
        // Abrir modal
        document.getElementById("btn-abrir-modal")?.addEventListener("click", () => {
            document.getElementById("modal-adicionar-meta").style.display = "flex";
        });
        (function () {
            // substitua por {{ cor_bg|default:"#ffffff" }} se necessário
            const bg = "{{ cor_bg|default:'#ffffff' }}";
            const fg = "{{ cor_fg|default:'#000000' }}";
            try {
                document.documentElement.style.setProperty('--comunidade-bg', bg);
                document.documentElement.style.setProperty('--comunidade-fg', fg);
                // também define --ranking-bg só se quiser
                // document.documentElement.style.setProperty('--ranking-bg', bg);
                console.log("vars set:", bg, fg);
            } catch (e) {
                console.error("Erro ao setar cores:", e);
            }
        })();

        // Fechar modal
        function fecharModal() {
            document.getElementById("modal-adicionar-meta").style.display = "none";
        }

        // Criar meta via AJAX
        document.getElementById("form-meta")?.addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("{% url 'criar_meta_ajax' comunidade.id %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": formData.get("csrfmiddlewaretoken")
                },
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "ok") {
                        location.reload();
                    } else {
                        alert("Erro ao criar meta: " + data.msg);
                    }
                });
        });

        // Aplicar tema da comunidade
        // Aplicar tema da comunidade — versão segura que respeita o style inline
        document.addEventListener("DOMContentLoaded", () => {
            const tema = document.querySelector(".tema-comunidade");
            if (!tema) return;

            // tenta pegar a variável já definida no style inline (se existir)
            let bg = tema.style.getPropertyValue('--comunidade-bg')?.trim();
            let fg = tema.style.getPropertyValue('--comunidade-fg')?.trim();

            // se não tiver no inline, tenta data-attrs (compatibilidade)
            if (!bg) bg = tema.getAttribute('data-bg') || "";
            if (!fg) fg = tema.getAttribute('data-fg') || "";

            // se ainda não tiver, usa fallback
            if (!bg) bg = "#ffffff";
            if (!fg) fg = "#000000";

            document.documentElement.style.setProperty("--comunidade-bg", bg);
            document.documentElement.style.setProperty("--comunidade-fg", fg);
        });


        // Aplicar cor mais clara no ranking
        document.addEventListener("DOMContentLoaded", () => {
            const tema = document.querySelector(".tema-comunidade");
            if (!tema) return;

            const bg = tema.getAttribute("data-bg") || "#ffffff";

            const rankingBg = lightenColor(bg, 0.6);
            document.documentElement.style.setProperty("--ranking-bg", rankingBg);
        });

        // função para clarear cor
        function lightenColor(hex, percent) {
            hex = hex.replace("#", "");
            const num = parseInt(hex, 16);
            let r = (num >> 16) + Math.round(255 * percent);
            let g = ((num >> 8) & 0x00FF) + Math.round(255 * percent);
            let b = (num & 0x0000FF) + Math.round(255 * percent);
            r = r > 255 ? 255 : r;
            g = g > 255 ? 255 : g;
            b = b > 255 ? 255 : b;
            return `rgb(${r}, ${g}, ${b})`;
        }
    </script>