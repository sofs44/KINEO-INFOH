{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat — Kineo</title>
  <link rel="stylesheet" href="{% static 'css/chat.css' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <!-- CSRF token for JS -->
  <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body>
<header>
  <div class="menu">
    <img src="{% static 'Assets/logo.png' %}" alt="Logo" class="logo" />
    <div class="icons">
      <!-- ícones existentes... -->
    </div>
  </div>
</header>

<div class="main-content">
  {% if not is_authenticated %}
    <!-- ... seu conteúdo para não logado ... -->
  {% else %}
    <div class="chat-page-container">
      <aside class="chat-sidebar">
        <div class="search-row">
          <div class="search-bar">
            <i class="fas fa-search"></i>
            <input id="chat-search" type="text" placeholder="Buscar amigo / grupo">
          </div>

          <!-- botão 3-bolinhas e área do ícone de lixeira (aparece no modo seleção) -->
          <div class="search-actions">
            <button id="menu-dots-btn" class="icon-btn" title="Mais opções"><i class="fas fa-ellipsis-v"></i></button>
            <button id="trash-selected-btn" class="icon-btn hidden" title="Apagar selecionados"><i class="fas fa-trash"></i></button>
          </div>
        </div>

        <div id="conversations-list" class="conversations-list">
          {% if conversations %}
            {% for conv in conversations %}
              <a href="{% url 'conversa' usuario_id=conv.id %}" 
                 data-conv-id="{{ conv.id }}" 
                 class="conversation-item {% if conv.is_active %}active{% endif %}">
                <div class="profile-pic-wrap">
                  {% if conv.foto_perfil %}
                    <img src="{{ conv.foto_perfil.url }}" alt="{{ conv.nome }}" class="profile-pic">
                  {% else %}
                    <div class="profile-pic default-pic"><i class="fas fa-user"></i></div>
                  {% endif %}
                </div>
                <div class="conversation-info">
                  <span class="name">{{ conv.nome }}</span>
                  <span class="last-message">{{ conv.last_message }}</span>
                </div>
                <!-- checkbox de seleção (escondido até modo seleção) -->
                <input type="checkbox" class="conv-select-checkbox hidden" aria-label="Selecionar conversa">
              </a>
            {% endfor %}
          {% else %}
            <p class="no-conversations">Você não tem conversas ativas.</p>
          {% endif %}
        </div>
      </aside>

      <main class="chat-main-area">
        {% if active_conversation %}
          <h2>{{ active_conversation.nome }}</h2>
          <div id="chat-box">
            {% for mensagem in mensagens %}
              <div class="message {% if mensagem.id_remetente == request.user %}from-me{% else %}from-you{% endif %}">
                {% if active_conversation.is_group %}
                  <small><strong>{{ mensagem.id_remetente.nome }}:</strong></small><br>
                {% endif %}
                {{ mensagem.mensagem }}
              </div>
            {% endfor %}
          </div>

          <div id="input-box">
            <form id="send-message-form" method="POST">
              {% csrf_token %}
              <input type="hidden" name="destinatario_id" value="{{ active_conversation.id }}">
              <textarea id="message-textarea" name="mensagem" placeholder="Digite sua mensagem..." rows="1"></textarea>
              <button type="submit" title="Enviar"><i class="fas fa-paper-plane"></i></button>
            </form>
          </div>
        {% else %}
          <div class="initial-message">
            <i class="fas fa-comment-dots"></i>
            <p>Escolha alguém ou um grupo para conversar</p>
          </div>
        {% endif %}
      </main>
    </div>
  {% endif %}
</div>

<!-- ===== MODAIS ===== -->
<!-- modal menu (aparece abaixo do botão 3-bolinhas) -->
<div id="menu-modal" class="modal-dropdown hidden" role="dialog" aria-hidden="true">
  <ul>
    <li><button id="start-delete-mode">Apagar contato</button></li>
    <li><button id="open-create-group-modal">Criar grupo</button></li>
  </ul>
</div>

<!-- modal de confirmação de exclusão -->
<div id="confirm-delete-modal" class="modal hidden" role="dialog" aria-hidden="true">
  <div class="modal-content">
    <h3>Apagar conversas</h3>
    <p>Tem certeza que deseja apagar as conversas selecionadas?</p>
    <div class="modal-actions">
      <button id="confirm-delete-yes" class="btn btn-danger">Sim, apagar</button>
      <button id="confirm-delete-no" class="btn">Cancelar</button>
    </div>
  </div>
</div>

<!-- modal de criar grupo -->
<div id="create-group-modal" class="modal hidden" role="dialog" aria-hidden="true">
  <div class="modal-content">
    <h3>Criar grupo</h3>
    <form id="create-group-form">
      <label>Nome do grupo</label>
      <input name="group_name" id="group-name" type="text" required>

      <label>Adicionar membros</label>
      <div id="users-to-add" class="users-list">
        <!-- será populado por JS: lista de conversas/usuários (a partir de DOM) -->
      </div>

      <label>Metas do grupo (opcional)</label>
      <div id="group-goals">
        <input name="goal[]" class="goal-input" type="text" placeholder="Ex: 10 treinos por semana">
      </div>
      <button id="add-goal-btn" type="button" class="btn small">+ adicionar meta</button>

      <div class="modal-actions" style="margin-top:12px;">
        <button type="submit" class="btn btn-primary">Criar grupo</button>
        <button type="button" id="cancel-create-group" class="btn">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- overlay (escura quando modal aberto) -->
<div id="modal-overlay" class="modal-overlay hidden"></div>

<script src="{% static 'js/chat.js' %}"></script>
</body>
</html>
